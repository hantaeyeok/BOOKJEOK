<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.bookjeok.notice.model.dao.NoticeMapper">

		<sql id="selectNotice">
		  SELECT
			    N.NOTICE_NO noticeNo,
			    N.NOTICE_TITLE noticeTitle,
			    N.NOTICE_CONTENT noticeContent,
			    N.NOTICE_DATE noticeDate,
			    N.NOTICE_VISITED noticeVisited,
			    F.NOTICE_IMGORI noticeImgOriginName,
			    F.NOTICE_TEXTORI noticeTextOriginName,
			    N.NOTICE_STATUS noticeStatus,
			    N.USER_ID userId
		   FROM
			    NOTICE N
	  LEFT JOIN 
	            NOTICE_FILE F ON N.NOTICE_NO = F.NOTICE_NO	 	   	  
		</sql>
		<select id="noticeCount" resultType="_int">
		   SELECT
				  COUNT(NOTICE_NO)
			 FROM
			      NOTICE
			 WHERE
			      NOTICE_STATUS = 'Y'
		</select>
		
		<select id="findAll" resultType="notice" parameterType="map">
			<include refid="selectNotice"/>
		      FROM
		          (SELECT
			            N.NOTICE_NO,
			            N.NOTICE_TITLE,
			            N.USER_ID,
			            N.NOTICE_VISITED,
			            N.NOTICE_DATE,
			            F.NOTICE_IMGORI,
			            F.NOTICE_TEXTORI,
			            ROWNUM RNUM
			        FROM
			            (
			                SELECT
			                    NOTICE.NO,
			                    NOTICE.TITLE,
			                    NOTICE.USER_ID,
			                    NOTICE.VISITED,
			                    NOTICE.DATE,
			                    NOTICE_FILE.IMGORI,
			                    NOTICE_FILE.TEXTORI
			                FROM
			                    NOTICE
			                LEFT JOIN NOTICE_FILE ON NOTICE.NOTICE_NO = NOTICE_FILE.NOTICE_NO
			                WHERE
			                    NOTICE_STATUS = 'Y'
			                ORDER BY
			                    NOTICE_NO DESC
			            ) 
			    )
		   WHERE
		        RNUM BETWEEN #{startValue} AND #{endValue}	
		</select>
		<select id="searchCount" resultType="hashmap" parameterType="int">
			<include refid="selectNotice"/>
		    FROM
		        NOTICE
		   WHERE
		        NOTICE_STATUS = 'Y'
		   <if test="condition == 'writer'">
		    AND
		       USER_ID
		   </if>
		   <if test="condition == 'title'">
		    AND
		       NOTICE_TITLE
		   </if>
		   <if test="condition == 'content'">
		    AND
		        NOTICE_CONTENT
		   </if>
		
		        LIKE '%' || #{keyword} || '%'
		</select>

		<select id="findByConditionAndKeyword" parameterType="hashmap" resultType="notice">
			<include refid="selectNotice"/>
		      FROM
		          NOTICE
		     WHERE
		          NOTICE_STATUS ='Y'
		
		  <choose>
		  	<when test="condition == 'writer'">
		  	   AND USER_ID
		  	</when>
		  	<when test="condition == 'title'">
		  	   AND NOTICE_TITLE
		  	</when>
		  	<otherwise>
		  	   AND NOTICE_CONTENT
		  	</otherwise>
		  </choose>
		      LIKE '%' || #{keyword} || '%'
		     ORDER
		        BY
		          NOTICE_NO DESC
		</select>
		
		
		<insert id="insert" parameterType="notice">
			INSERT
			  INTO
			      NOTICE
			      (
			      NOTICE_NO,
			      NOTICE_TITLE,
			      NOTICE_CONTENT,
			      USER_ID,
			      NOTICE_IMGORI,
			      NOTICE_TEXTORI
			      )
		     VALUE
		</insert>
		
		<update id="increaseCount" parameterType="_int">
			UPDATE
				   NOTICE
			   SET
				   NOTICE_VISITED = NOTICE_VISITED + 1
			 WHERE
			 	   NOTICE_NO = #{noticeNo}
			   AND
			   	   NOTICE_STATUS = 'Y'
		</update>
		
		<select id="findById" parameterType="_int" resultType="notice">
			<include refid="selectNotice" />
			 FROM
				  NOTICE
			WHERE
				  NOTICE_NO = #{noticeNo}
		</select>

		<update id="delete" parameterType="_int">
			UPDATE
				   NOTICE
			   SET
			   	   NOTICE_STATUS = 'N'
			 WHERE
			 	   NOTICE_NO = #{noticeNo}
		</update>

		<update id="update" parameterType="notice">
			UPDATE
				   NOTICE
			   SET
				   NOTICE_TITLE = #{noticeTitle},
				   NOTICE_CONTENT = #{noticeContent},
				   NOTICE_IMGORI = #{noticeImgOriginName},
				   NOTICE_IMGCHAN = #{noticeImgChangeName},
				   NOTICE_TEXTORI = #{noticeTextOriginName},
				   NOTICE_TEXTCHAN = #{noticeTextChangeName},
			 WHERE
				   NOTICE_NO = #{noticeNo}
		</update>

		<!--  -->
		<select id="selectNoticeFile" resultType="noticeFile" parameterType="noticeFile">
			SELECT
				NOTICE_NO noticeNo,
				NOTICE_IMGORI noticeImgOriginName,
				NOTICE_TEXTORI noticeTextOriginName
			FROM
				NOTICE
			WHERE
				NOTICE_STATUS = 'Y'
			AND
				SEQ_NNO = #{noticeNo}
				
			ORDER
			   BY
				NOTICE_NO DESC               	
		</select>

		<!-- update를 할 떄 공지사항 글만 업데이를 하면 되는지(첨부파일 포함) , 아님 파일을 따로 업데이트 해야 하는지  -->	
		<select id="updateNoticeFile" resultType="noticeFile" parameterType="noticeFile">
		  INSERT
			INTO
				NOTICE_FILE
				(
				NOTICE_NO noticeNo,
				NOTICE_IMGORI noticeImgOriginName,
				NOTICE_TEXTORI noticeTextOriginName
				)
		  VALUES
			    (
				#{noticeNo},
				#{noticeImgOriginName},
				#{noticeTextOriginName}
				)
				
		</select>	


		
		
		<select id="noticeList" resultType="notice">
			<include refid="selectNotice" />
		
		</select>
</mapper>